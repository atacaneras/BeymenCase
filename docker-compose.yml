services:
  # RabbitMQ
  rabbitmq:
    image: rabbitmq:3-management
    container_name: beymen-rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin123
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - beymen-network

  # PostgreSQL - Identity Database
  postgres-identity:
    image: postgres:15
    container_name: beymen-postgres-identity
    ports:
      - "5437:5432"
    environment:
      POSTGRES_DB: IdentityDb
      POSTGRES_USER: identityuser
      POSTGRES_PASSWORD: identitypass123
    volumes:
      - identity-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U identityuser -d IdentityDb"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - beymen-network

  # PostgreSQL - Order Database
  postgres-order:
    image: postgres:15
    container_name: beymen-postgres-order
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: OrderDb
      POSTGRES_USER: orderuser
      POSTGRES_PASSWORD: orderpass123
    volumes:
      - order-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U orderuser -d OrderDb"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - beymen-network

  # PostgreSQL - Stock Database
  postgres-stock:
    image: postgres:15
    container_name: beymen-postgres-stock
    ports:
      - "5433:5432"
    environment:
      POSTGRES_DB: StockDb
      POSTGRES_USER: stockuser
      POSTGRES_PASSWORD: stockpass123
    volumes:
      - stock-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U stockuser -d StockDb"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - beymen-network

  # PostgreSQL - Notification Database
  postgres-notification:
    image: postgres:15
    container_name: beymen-postgres-notification
    ports:
      - "5434:5432"
    environment:
      POSTGRES_DB: NotificationDb
      POSTGRES_USER: notificationuser
      POSTGRES_PASSWORD: notificationpass123
    volumes:
      - notification-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U notificationuser -d NotificationDb"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - beymen-network

  # PostgreSQL - Verification Database
  postgres-verification:
    image: postgres:15
    container_name: beymen-postgres-verification
    ports:
      - "5435:5432"
    environment:
      POSTGRES_DB: VerificationDb
      POSTGRES_USER: verificationuser
      POSTGRES_PASSWORD: verificationpass123
    volumes:
      - verification-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U verificationuser -d VerificationDb"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - beymen-network

  # PostgreSQL - Invoice Database
  postgres-invoice:
    image: postgres:15
    container_name: beymen-postgres-invoice
    ports:
      - "5436:5432"
    environment:
      POSTGRES_DB: InvoiceDb
      POSTGRES_USER: invoiceuser
      POSTGRES_PASSWORD: invoicepass123
    volumes:
      - invoice-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U invoiceuser -d InvoiceDb"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - beymen-network

  # Identity Service
  identity-service:
    build:
      context: .
      dockerfile: IdentityService/Dockerfile
    container_name: beymen-identity-service
    ports:
      - "5000:80"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80
      - ConnectionStrings__DefaultConnection=Host=postgres-identity;Database=IdentityDb;Username=identityuser;Password=identitypass123
      - JwtSettings__SecretKey=BeymenCase-SuperSecure-JWT-Secret-Key-2024-MustBe-AtLeast-32Characters-Long-ForSecurity
      - JwtSettings__Issuer=IdentityService
      - JwtSettings__Audience=BeymenCase
      - JwtSettings__AccessTokenExpiryMinutes=60
      - JwtSettings__RefreshTokenExpiryDays=7
    depends_on:
      postgres-identity:
        condition: service_healthy
    networks:
      - beymen-network
    restart: on-failure

  # Order Service
  order-service:
    build:
      context: .
      dockerfile: OrderService/Dockerfile
    container_name: beymen-order-service
    ports:
      - "5001:80"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80
      - ConnectionStrings__DefaultConnection=Host=postgres-order;Database=OrderDb;Username=orderuser;Password=orderpass123
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Username=admin
      - RabbitMQ__Password=admin123
      - RabbitMQ__Port=5672
      - Services__StockService=http://stock-service
      - Services__NotificationService=http://notification-service
      - Services__IdentityService=http://identity-service
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres-order:
        condition: service_healthy
      identity-service:
        condition: service_started
    networks:
      - beymen-network
    restart: on-failure

  # Stock Service
  stock-service:
    build:
      context: .
      dockerfile: StockService/Dockerfile
    container_name: beymen-stock-service
    ports:
      - "5002:80"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80
      - ConnectionStrings__DefaultConnection=Host=postgres-stock;Database=StockDb;Username=stockuser;Password=stockpass123
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Username=admin
      - RabbitMQ__Password=admin123
      - RabbitMQ__Port=5672
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres-stock:
        condition: service_healthy
    networks:
      - beymen-network
    restart: on-failure

  # Notification Service
  notification-service:
    build:
      context: .
      dockerfile: NotificationService/Dockerfile
    container_name: beymen-notification-service
    ports:
      - "5003:80"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80
      - ConnectionStrings__DefaultConnection=Host=postgres-notification;Database=NotificationDb;Username=notificationuser;Password=notificationpass123
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Username=admin
      - RabbitMQ__Password=admin123
      - RabbitMQ__Port=5672
      - Services__InvoiceService=http://invoice-service
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres-notification:
        condition: service_healthy
    networks:
      - beymen-network
    restart: on-failure

  # Verification Service
  verification-service:
    build:
      context: .
      dockerfile: VerificationService/Dockerfile
    container_name: beymen-verification-service
    ports:
      - "5004:80"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80
      - ConnectionStrings__DefaultConnection=Host=postgres-verification;Database=VerificationDb;Username=verificationuser;Password=verificationpass123
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Username=admin
      - RabbitMQ__Password=admin123
      - RabbitMQ__Port=5672
      - Services__OrderService=http://order-service
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres-verification:
        condition: service_healthy
    networks:
      - beymen-network
    restart: on-failure

  # Invoice Service
  invoice-service:
    build:
      context: .
      dockerfile: InvoiceService/Dockerfile
    container_name: beymen-invoice-service
    ports:
      - "5005:80"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80
      - ConnectionStrings__DefaultConnection=Host=postgres-invoice;Database=InvoiceDb;Username=invoiceuser;Password=invoicepass123
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Username=admin
      - RabbitMQ__Password=admin123
      - RabbitMQ__Port=5672
      - Services__OrderService=http://order-service
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres-invoice:
        condition: service_healthy
    networks:
      - beymen-network
    restart: on-failure

  # Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: beymen-frontend
    ports:
      - "3001:3000"
    environment:
      - REACT_APP_IDENTITY_API=http://identity-service:80
      - REACT_APP_API_BASE=http://order-service:80
      - REACT_APP_STOCK_API=http://stock-service:80
      - REACT_APP_NOTIFICATION_API=http://notification-service:80
      - REACT_APP_VERIFICATION_API=http://verification-service:80
      - REACT_APP_INVOICE_API=http://invoice-service:80
    networks:
      - beymen-network
    restart: on-failure
    depends_on:
      - identity-service
      - order-service
      - stock-service
      - notification-service
      - verification-service
      - invoice-service

volumes:
  identity-data:
  order-data:
  stock-data:
  notification-data:
  verification-data:
  invoice-data:

networks:
  beymen-network:
    driver: bridge